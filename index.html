<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ماهراد ۳۶۰ - ارزیابی عملکرد</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.6/dist/jalaali.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    body {background:#0f172a;color:#e2e8f0;font-family:'Vazirmatn',sans-serif;min-height:100vh}
    .glass{background:rgba(30,41,59,.95);backdrop-filter:blur(20px);border-radius:28px;border:1px solid #0ea5e933;box-shadow:0 20px 60px #000000b3;padding:2rem}
    .card{background:#1e293b;border-radius:20px;padding:20px;transition:.4s}
    .card:hover{transform:translateY(-10px);box-shadow:0 20px 50px #0ea5e950}
    .range{height:16px;border-radius:50px;background:#334155}
    .range::-webkit-slider-thumb{appearance:none;width:38px;height:38px;border-radius:50%;background:#10b981;box-shadow:0 0 30px #10b98180}
    .avatar{width:110px;height:110px;border-radius:50%;background:linear-gradient(45deg,#0ea5e9,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:3.5rem;color:#fff;font-weight:bold}
    .shamsi{font-size:2.8rem;font-weight:900;background:linear-gradient(45deg,#8b5cf6,#ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .grade-A{color:#10b981;text-shadow:0 0 40px #10b98160}
    .grade-B{color:#3b82f6}
    .grade-C{color:#fbbf24}
    .grade-D{color:#f97316}
    .grade-E{color:#ef4444;text-shadow:0 0 40px #ef444460}
  </style>
</head>
<body class="p-4">

<div id="app">
  <!-- ورود -->
  <div v-if="!loggedIn" class="d-flex justify-content-center align-items-center min-vh-100">
    <div class="text-center">
      <svg width="240" height="240" viewBox="0 0 240 240" class="mb-4">
        <circle cx="120" cy="120" r="110" fill="#8b5cf6"/>
        <text x="120" y="140" font-size="60" fill="white" text-anchor="middle" font-weight="bold">ماهراد</text>
      </svg>
      <h1 class="text-white display-4 fw-bold mb-5">سامانه ارزیابی ۳۶۰ درجه</h1>
      <div class="glass p-5 col-md-5 mx-auto">
        <input v-model="loginCode" @keyup.enter="login" class="form-control form-control-lg text-center mb-4 fs-2" placeholder="کد پرسنلی" autofocus>
        <button @click="login" class="btn btn-primary btn-lg w-100 fs-4">ورود</button>
        <small class="text-info mt-3 d-block">مدیر: admin</small>
      </div>
    </div>
  </div>

  <!-- داشبورد -->
  <div v-else class="glass">
    <div class="d-flex justify-content-between align-items-center mb-5">
      <div class="d-flex align-items-center gap-4">
        <div class="avatar">{{ currentUser.name?.[0] || 'م' }}</div>
        <div>
          <h2 class="text-white fw-bold fs-1 mb-1">سلام، {{ currentUser.name }}</h2>
          <p class="text-info fs-3">{{ currentUser.dept }} • {{ currentUser.position }}</p>
        </div>
      </div>
      <div class="text-end">
        <div class="shamsi" ref="shamsiEl"></div>
        <div class="text-white fs-3" ref="clockEl"></div>
      </div>
    </div>

    <ul class="nav nav-tabs mb-5 fs-5">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#eval">ارزیابی</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#chart">نمودار من</a></li>
      <li v-if="isAdmin" class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#admin">مدیریت</a></li>
      <li class="nav-item"><a @click="logout" class="nav-link text-danger">خروج</a></li>
    </ul>

    <div class="tab-content">
      <!-- ارزیابی -->
      <div class="tab-pane active" id="eval">
        <select v-model="targetCode" class="form-select form-select-lg mb-5 text-center fs-4">
          <option value="">انتخاب همکار</option>
          <option v-for="p in personnel" :value="p.code">{{ p.name }} - {{ p.dept }}</option>
        </select>

        <div v-if="targetCode" class="row g-4">
          <div class="col-md-6" v-for="(q,i) in questions" :key="i">
            <div class="card text-center">
              <h5 class="text-white mb-4">{{ q }}</h5>
              <input type="range" class="form-range range" min="1" max="5" v-model.number="scores[i]" @input="colorSlider($event.target,i)">
              <div class="mt-4">
                <span class="fs-1 fw-bold" :style="{color:scoreColor(scores[i])}">{{ scores[i] }}</span>
                <p class="text-white-50 fs-5">{{ scoreText(scores[i]) }}</p>
              </div>
            </div>
          </div>
        </div>
        <button v-if="targetCode" @click="submit" class="btn btn-success btn-lg w-100 mt-5 fs-3">ارسال ارزیابی</button>
      </div>

      <!-- نمودار -->
      <div class="tab-pane" id="chart">
        <div class="text-center py-5">
          <h2 class="text-info display-4 fw-bold mb-5">نمودار عملکرد ۳۶۰ درجه شما</h2>
          <canvas ref="radar" height="600"></canvas>
          <h1 class="display-1 mt-5" :class="'grade-'+myGrade">{{ myGrade }}</h1>
          <p class="fs-2 text-info">میانگین: {{ myAvg.toFixed(2) }}</p>
        </div>
      </div>

      <!-- مدیریت -->
      <div v-if="isAdmin" class="tab-pane" id="admin">
        <button @click="exportExcel" class="btn btn-outline-light btn-lg mb-4">دانلود اکسل</button>
        <table class="table table-dark table-hover text-center">
          <thead class="table-primary"><tr><th>نام</th><th>واحد</th><th>تعداد</th><th>میانگین</th><th>گرید</th></tr></thead>
          <tbody>
            <tr v-for="p in personnel">
              <td>{{p.name}}</td><td>{{p.dept}}</td><td>{{p.evals?.length||0}}</td><td>{{avg(p).toFixed(2)}}</td><td :class="'grade-'+grade(avg(p))"><strong>{{grade(avg(p))}}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
let chart = null;
const { createApp, ref, onMounted, computed } = Vue;

createApp({
  setup() {
    const loginCode = ref('');
    const loggedIn = ref(false);
    const isAdmin = ref(false);
    const currentUser = ref({});
    const personnel = ref([]);
    const targetCode = ref('');
    const scores = ref(Array(21).fill(3));
    const shamsiEl = ref(null);
    const clockEl = ref(null);
    const radar = ref(null);

    const questions = ref([
      "دقت و کیفیت کار", "سرعت انجام کار", "همکاری تیمی", "مسئولیت پذیری", "نوآوری و خلاقیت",
      "انضباط کاری", "ارتباطات موثر", "حل مسئله", "یادگیری و توسعه", "رهبری", "مدیریت زمان",
      "رضایت مشتری", "تعهد سازمانی", "مدیریت استرس", "انعطاف پذیری", "کار تحت فشار",
      "ارائه گزارش", "رعایت ایمنی", "بهبود مستمر", "مشارکت در جلسات", "حفظ محرمانگی"
    ]);

    const myAvg = computed(() => currentUser.value.evals?.length ? currentUser.value.evals.reduce((a,e)=>a+e.scores.reduce((x,y)=>x+y,0),0)/(currentUser.value.evals.length*21) : 0);
    const myGrade = computed(() => myAvg.value >= 4.5 ? 'A' : myAvg.value >= 4 ? 'B' : myAvg.value >= 3.5 ? 'C' : myAvg.value >= 3 ? 'D' : 'E');

    const login = () => {
      if (loginCode.value === 'admin') { isAdmin.value = true; currentUser.value = {name:'مدیر سیستم',dept:'مدیریت'}; loggedIn.value = true; return; }
      const user = personnel.value.find(p => p.code === loginCode.value);
      if (user) { currentUser.value = user; loggedIn.value = true; }
      else alert('کد اشتباه!');
    };

    const logout = () => { loggedIn.value = false; loginCode.value = ''; isAdmin.value = false; };

    const submit = () => {
      const target = personnel.value.find(p => p.code === targetCode.value);
      target.evals = target.evals || [];
      target.evals.push({from: currentUser.value.code || 'admin', scores: [...scores.value]});
      localStorage.setItem('mahrad360', JSON.stringify(personnel.value));
      alert('ثبت شد!');
      targetCode.value = ''; scores.value = Array(21).fill(3);
    };

    const avg = p => p.evals?.length ? p.evals.reduce((a,e)=>a+e.scores.reduce((x,y)=>x+y,0),0)/(p.evals.length*21) : 0;
    const grade = a => a>=4.5?'A':a>=4?'B':a>=3.5?'C':a>=3?'D':'E';
    const scoreColor = s => s<=2?'#ef4444':s<=3?'#f59e0b':s==4?'#eab308':'#10b981';
    const scoreText = s => ['ضعیف','نیاز به بهبود','متوسط','خوب','عالی'][s-1];
    const colorSlider = (el,i) => {
      const p = (scores.value[i]-1)/4*100;
      el.style.background = `linear-gradient(to right, #ef4444 0%, #f59e0b ${p/2}%, #10b981 ${p}%, #10b981 100%)`;
    };

    const drawChart = () => {
      if (chart) chart.destroy();
      const data = currentUser.value.evals?.length ? 
        currentUser.value.evals.reduce((acc,e)=>e.scores.map((s,i)=>acc[i]=(acc[i]||0)+s,acc),Array(21).fill(0)).map((s,i)=>s/currentUser.value.evals.length) :
        Array(21).fill(3);

      chart = new Chart(radar.value, {
        type: 'radar',
        data: { labels: questions.value, datasets: [{ label: 'عملکرد شما', data, backgroundColor: 'rgba(14,165,233,0.3)', borderColor: '#0ea5e9', pointBackgroundColor: '#8b5cf6', borderWidth: 4 }] },
        options: { scales: { r: { min:0, max:5, ticks:{stepSize:1} } } }
      });
    };

    const exportExcel = () => {
      const data = personnel.value.map(p=>({نام:p.name,واحد:p.dept,تعداد:p.evals?.length||0,میانگین:avg(p).toFixed(2),گرید:grade(avg(p))}));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"گزارش");
      XLSX.writeFile(wb,"Mahrad360.xlsx");
    };

    onMounted(() => {
      const saved = localStorage.getItem('mahrad360');
      if (saved) personnel.value = JSON.parse(saved);
      else {
        personnel.value = [
          {code:"1001",name:"سیاوش قوچانی",dept:"فنی",position:"کارشناس",evals:[]},
          {code:"1004",name:"محمدرضا شفیعی",dept:"فنی",position:"مدیر پروژه",evals:[]},
          {code:"1007",name:"حدیقه کیقبادی",dept:"مالی",position:"حسابدار",evals:[]}
        ];
        localStorage.setItem('mahrad360', JSON.stringify(personnel.value));
      }

      setInterval(() => {
        const d = new Date();
        const j = jalaali.toJalaali(d.getFullYear(), d.getMonth()+1, d.getDate());
        if (shamsiEl.value) shamsiEl.value.innerText = `${j.jy}/${j.jm.toString().padStart(2,'0')}/${j.jd.toString().padStart(2,'0')}`;
        if (clockEl.value) clockEl.value.innerText = d.toLocaleTimeString('fa-IR');
      }, 1000);
    });

    return { loginCode, loggedIn, isAdmin, currentUser, personnel, targetCode, scores, questions, shamsiEl, clockEl, radar, login, logout, submit, myAvg, myGrade, avg, grade, scoreColor, scoreText, colorSlider, drawChart, exportExcel };
  }
}).mount('#app');
</script>
</body>
</html>
