<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ماهراد ۳۶۰ - ارزیابی عملکرد</title>
  <!-- favicon رو هم درست کردم که 404 نده -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚡</text></svg>">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.6/dist/jalaali.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    body{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-family:'Vazirmatn',sans-serif;min-height:100vh;margin:0}
    .glass{background:rgba(255,255,255,0.12);backdrop-filter:blur(20px);border-radius:20px;border:1px solid rgba(255,255,255,0.2);box-shadow:0 15px 35px rgba(0,0,0,0.3)}
    .card{background:rgba(255,255,255,0.1);backdrop-filter:blur(15px);border-radius:18px;border:none;transition:.4s}
    .card:hover{transform:translateY(-8px)}
    .grade-circle{width:150px;height:150px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:5rem;font-weight:900;box-shadow:0 0 50px}
    .A{background:#10b981;box-shadow:0 0 50px #10b98190}
    .B{background:#3b82f6;box-shadow:0 0 50px #3b82f690}
    .C{background:#fbbf24;box-shadow:0 0 50px #fbbf2490}
    .D{background:#f97316;box-shadow:0 0 50px #f9731690}
    .E{background:#ef4444;box-shadow:0 0 50px #ef444490}
    .shamsi{font-size:3.2rem;font-weight:900;background:linear-gradient(45deg,#fff,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .progress-ring{position:relative;width:170px;height:170px}
    .progress-ring svg{transform:rotate(-90deg)}
    .progress-ring circle{fill:none;stroke:#334155;stroke-width:15}
    .progress-ring .bar{stroke:#10b981;stroke-linecap:round;stroke-width:15;transition:.8s}
    .progress-ring .text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2.8rem;font-weight:900}
  </style>
</head>
<body class="p-4">

<div id="app" v-cloak>
  <!-- صفحه ورود -->
  <div v-if="userRole === 'none'" class="d-flex align-items-center justify-content-center min-vh-100">
    <div class="glass p-5 text-center" style="max-width:460px;width:100%">
      <h1 class="display-2 fw-bold mb-5 text-warning">ماهراد ۳۶۰</h1>
      <input v-model="loginCode" @keyup.enter="doLogin" class="form-control form-control-lg text-center mb-4 fs-1" placeholder="کد پرسنلی" autofocus>
      <button @click="doLogin" class="btn btn-light btn-lg w-100 fs-3 fw-bold">ورود</button>
      <small class="d-block mt-4 text-info">مدیر → کد: <code>admin</code></small>
    </div>
  </div>

  <!-- داشبورد -->
  <div v-else class="glass p-5">
    <div class="d-flex justify-content-between align-items-center mb-5">
      <div>
        <h1 class="shamsi mb-2">{{shamsiDate}}</h1>
        <h2 class="fw-bold fs-3">سامانه ارزیابی عملکرد ۳۶۰ درجه</h2>
      </div>
      <button @click="doLogout" class="btn btn-outline-light btn-lg px-5">خروج</button>
    </div>

    <!-- مدیر -->
    <div v-if="userRole === 'admin'" class="row g-4 mb-5 text-center">
      <div class="col-12">
        <div class="card p-4">
          <h3>آپلود اکسل پرسنل</h3>
          <input type="file" @change="importExcel" accept=".xlsx" class="form-control form-control-lg">
          <small class="text-warning">ستون‌ها: کد، نام، واحد، سمت</small>
        </div>
      </div>
      <div class="col-lg-4 col-md-6" v-for="d in departments">
        <div class="card p-4">
          <h4>{{d.name}}</h4>
          <h2>{{d.count}} نفر</h2>
          <div class="progress mt-3" style="height:32px">
            <div class="progress-bar bg-success" :style="{width: d.avg*20 + '%'}">{{d.avg.toFixed(2)}}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- پرسنل -->
    <div v-if="userRole === 'employee'" class="row g-4 text-center mb-5">
      <div class="col-md-3 col-6"><div class="card p-4"><h5>تکمیل ارزیابی</h5><div class="progress-ring mx-auto"><svg width="170" height="170"><circle cx="85" cy="85" r="77"/><circle cx="85" cy="85" r="77" class="bar" stroke-dasharray="502" :stroke-dashoffset="offset"/></svg><div class="text">{{percent}}%</div></div></div></div>
      <div class="col-md-3 col-6"><div class="card p-4"><h5>پاداش</h5><h1 class="text-warning">{{bonus.toLocaleString('fa-IR')}} تومان</h1></div></div>
      <div class="col-md-3 col-6"><div class="card p-4"><h5>گرید</h5><div class="grade-circle mx-auto" :class="grade">{{grade}}</div></div></div>
      <div class="col-md-3 col-6"><div class="card p-4"><h5>امتیاز</h5><h1>{{avg.toFixed(2)}} از ۵</h1></div></div>
    </div>

    <div class="row">
      <div class="col-lg-8">
        <div class="card p-4">
          <h3 class="text-center mb-4">{{userRole === 'admin' ? 'میانگین دپارتمان‌ها' : 'نمودار عملکرد من'}}</h3>
          <canvas ref="radarChart" height="400"></canvas>
        </div>
      </div>
      <div class="col-lg-4">
        <div v-if="userRole === 'admin'" class="card p-4">
          <h4>دپارتمان‌ها</h4>
          <div v-for="d in departments" class="bg-white bg-opacity-10 rounded p-3 mb-3 cursor-pointer" @click="d.show = !d.show">
            <strong>{{d.name}} ({{d.count}} نفر)</strong>
            <div v-if="d.show" class="small mt-2">
              <div v-for="p in d.people">{{p.name}} - {{p.position || '—'}}</div>
            </div>
          </div>
        </div>
        <div v-else class="card p-4">
          <h4>اطلاعات من</h4>
          <p><strong>نام:</strong> {{currentUser.name}}</p>
          <p><strong>واحد:</strong> {{currentUser.dept || '—'}}</p>
          <p><strong>سمت:</strong> {{currentUser.position || '—'}}</p>
          <p><strong>کد:</strong> {{currentUser.code}}</p>
        </div>
      </div>
    </div>

    <!-- ارزیابی -->
    <ul class="nav nav-tabs mt-5">
      <li class="nav-item"><a class="nav-link active fs-5" data-bs-toggle="tab" href="#eval">ارزیابی همکاران</a></li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane active card p-4" id="eval">
        <select v-model="selectedPerson" class="form-select form-select-lg mb-4">
          <option :value="null">انتخاب همکار</option>
          <option v-for="p in people" :value="p" v-if="p.code !== currentUser.code">{{p.name}} - {{p.dept}}</option>
        </select>
        <div v-if="selectedPerson" class="row g-3">
          <div class="col-md-6" v-for="(q,i) in questions" :key="i">
            <label class="form-label fw-bold">{{q}}</label>
            <input type="range" class="form-range" min="1" max="5" v-model.number="scores[i]" @input="e=>e.target.style.background=`linear-gradient(to right,#ef4444 ${(scores[i]-1)*25}%,#10b981 ${(scores[i]-1)*25}%)`">
            <div class="d-flex justify-content-between"><small>ضعیف</small><strong class="fs-3">{{scores[i]}}</strong><small>عالی</small></div>
          </div>
        </div>
        <button v-if="selectedPerson" @click="submitEval" class="btn btn-success btn-lg w-100 mt-4">ارسال ارزیابی</button>
      </div>
    </div>
  </div>
</div>

<script>
const { createApp, ref, computed, onMounted, nextTick } = Vue
let chart = null

createApp({
  setup() {
    const userRole = ref('none') // 'none' | 'admin' | 'employee'
    const loginCode = ref('')
    const currentUser = ref({})
    const people = ref([])
    const selectedPerson = ref(null)
    const scores = ref(Array(21).fill(3))
    const radarChart = ref(null)
    const shamsiDate = ref('')

    const questions = ["دقت و کیفیت کار","سرعت انجام کار","همکاری تیمی","مسئولیت پذیری","نوآوری و خلاقیت","انضباط کاری","ارتباطات موثر","حل مسئله","یادگیری و توسعه","رهبری","مدیریت زمان","رضایت مشتری","تعهد سازمانی","مدیریت استرس","انعطاف پذیری","کار تحت فشار","ارائه گزارش","رعایت ایمنی","بهبود مستمر","مشارکت در جلسات","حفظ محرمانگی"]

    const load = () => { const d = localStorage.getItem('mahrad360_final_2025'); if (d) people.value = JSON.parse(d) }
    const save = () => localStorage.setItem('mahrad360_final_2025', JSON.stringify(people.value))

    const doLogin = async () => {
      if (loginCode.value === 'admin') {
        userRole.value = 'admin'
        currentUser.value = { name: 'مدیر سیستم', code: 'admin' }
      } else {
        const user = people.value.find(p => p.code === loginCode.value)
        if (!user) return alert('کد اشتباه!')
        userRole.value = 'employee'
        currentUser.value = user
      }
      await nextTick()
      drawChart()
    }

    const doLogout = () => { userRole.value = 'none'; loginCode.value = '' }

    const departments = computed(() => {
      const map = {}
      people.value.forEach(p => {
        const d = p.dept || 'نامشخص'
        if (!map[d]) map[d] = { name: d, count: 0, people: [], avg: 0, show: false }
        map[d].count++
        map[d].people.push(p)
      })
      return Object.values(map).map(dept => {
        dept.avg = dept.count ? dept.people.reduce((s, p) => s + calcAvg(p), 0) / dept.count : 0
        return dept
      })
    })

    const calcAvg = p => p.evals?.length ? p.evals.reduce((a,e) => a + e.scores.reduce((x,y)=>x+y,0),0)/(p.evals.length*21) : 0
    const avg = computed(() => userRole.value === 'admin' ? 0 : calcAvg(currentUser.value))
    const grade = computed(() => avg.value >= 4.5 ? 'A' : avg.value >= 4 ? 'B' : avg.value >= 3.5 ? 'C' : avg.value >= 3 ? 'D' : 'E')
    const percent = computed(() => Math.round((avg.value / 5) * 100))
    const bonus = computed(() => Math.round(avg.value * 1800000 * (grade.value === 'D' ? 0.8 : grade.value === 'E' ? 0.5 : 1)))
    const offset = computed(() => 502 - (502 * percent.value / 100))

    const drawChart = () => {
      if (!radarChart.value) return
      if (chart) chart.destroy()
      const data = userRole.value === 'admin' 
        ? departments.value.map(d => d.avg)
        : currentUser.value.evals?.length 
          ? currentUser.value.evals.reduce((a,e)=>e.scores.map((s,i)=>(a[i]||0)+s), Array(21).fill(0)).map(v => v / currentUser.value.evals.length)
          : Array(21).fill(3)
      const labels = userRole.value === 'admin' ? departments.value.map(d => d.name) : questions

      chart = new Chart(radarChart.value, {
        type: 'radar',
        data: { labels, datasets: [{ label: userRole.value === 'admin' ? 'میانگین' : 'عملکرد من', data, backgroundColor: 'rgba(99,102,241,0.3)', borderColor: '#6366f1', borderWidth: 4 }] },
        options: { scales: { r: { min: 0, max: 5, ticks: { stepSize: 1 } } } }
      })
    }

    const submitEval = () => {
      selectedPerson.value.evals = selectedPerson.value.evals || []
      selectedPerson.value.evals.push({ from: currentUser.value.code, scores: [...scores.value] })
      save()
      alert('ارزیابی ثبت شد')
      selectedPerson.value = null
      scores.value = Array(21).fill(3)
      drawChart()
    }

    const importExcel = e => {
      const file = e.target.files[0]
      if (!file) return
      const reader = new FileReader()
      reader.onload = ev => {
        const wb = XLSX.read(ev.target.result)
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]])
        people.value = rows.map(r => ({ code: String(r.کد||''), name: r.نام||'', dept: r.واحد||'نامشخص', position: r.سمت||'', evals: [] }))
        save()
        alert(`${people.value.length} نفر وارد شد`)
      }
      reader.readAsArrayBuffer(file)
    }

    onMounted(() => {
      load()
      setInterval(() => {
        const d = new Date()
        const j = jalaali.toJalaali(d.getFullYear(), d.getMonth()+1, d.getDate())
        shamsiDate.value = `${j.jy}/${j.jm.toString().padStart(2,'0')}/${j.jd.toString().padStart(2,'0')}`
      }, 1000)
    })

    return { userRole, loginCode, currentUser, people, selectedPerson, scores, radarChart, shamsiDate, questions, avg, grade, percent, bonus, offset, departments, doLogin, doLogout, submitEval, drawChart, importExcel }
  }
}).mount('#app')
</script>
</body>
</html>
