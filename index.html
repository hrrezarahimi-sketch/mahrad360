<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ماهراد ۳۶۰ | سامانه ارزیابی عملکرد</title>

  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.6/dist/jalaali.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root {--primary:#0ea5e9;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--purple:#8b5cf6;}
    body {background: linear-gradient(135deg,#0f172a,#1e293b);color:#e2e8f0;font-family:'Vazirmatn',sans-serif;min-height:100vh;}
    .glass {background:rgba(30,41,59,0.95);backdrop-filter:blur(20px);border-radius:28px;border:1px solid rgba(14,165,233,0.3);box-shadow:0 20px 60px rgba(0,0,0,0.7);}
    .card-eval {background:linear-gradient(145deg,#1e293b,#334155);border-radius:24px;padding:24px;transition:all .4s;}
    .card-eval:hover {transform:translateY(-12px);box-shadow:0 25px 50px rgba(14,165,233,0.5);}
    .btn-primary {background:linear-gradient(45deg,var(--primary),#22d3ee);border:none;border-radius:20px;font-weight:700;}
    .shamsi-date {font-size:2.8rem;font-weight:900;background:linear-gradient(45deg,var(--purple),#ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .avatar {width:110px;height:110px;border-radius:50%;background:linear-gradient(45deg,var(--primary),var(--purple));display:flex;align-items:center;justify-content:center;font-size:3.5rem;color:white;font-weight:bold;box-shadow:0 0 30px rgba(14,165,233,0.6);}
    .range-slider {height:16px;border-radius:50px;background:#334155;transition:all .4s;}
    .range-slider::-webkit-slider-thumb {appearance:none;width:38px;height:38px;border-radius:50%;background:var(--success);box-shadow:0 0 30px rgba(16,185,129,0.8);}
,0);}
    .grade-A{color:var(--success);text-shadow:0 0 40px #10b98160;}
    .grade-B{color:#3b82f6;}
    .grade-C{color:var(--warning);}
    .grade-D{color:#f97316;}
    .grade-E{color:var(--danger);text-shadow:0 0 40px #ef444460;}
  </style>
</head>
<body>

<div id="app" class="p-4 min-vh-100">
  <!-- ورود -->
  <div v-if="!loggedIn" class="d-flex justify-content-center align-items-center min-vh-100">
    <div class="text-center">
      <img src="https://i.ibb.co/4g5v5sF/mahrad-logo-real.png" onerror="this.src='https://via.placeholder.com/240/0ea5e9/fff?text=ماهراد'" width="240" class="mb-4 rounded-4 shadow-lg">
      <h1 class="text-white mb-5 display-4 fw-bold">سامانه ارزیابی ۳۶۰ درجه</h1>
      <div class="glass p-5 col-md-6 mx-auto">
        <input v-model="loginCode" class="form-control form-control-lg text-center mb-4 fs-2" placeholder="کد پرسنلی" autofocus>
        <button @click="login" class="btn btn-primary btn-lg w-100 fs-4">ورود به سامانه</button>
        <small class="text-info mt-3 d-block">مدیر سیستم: admin</small>
      </div>
    </div>
  </div>

  <!-- داشبورد -->
  <div v-else class="container mt-4">
    <div class="glass p-5">
      <div class="d-flex justify-content-between align-items-center mb-5">
        <div class="d-flex align-items-center gap-4">
          <div class="avatar">{{ currentUser.name?.[0] || '?' }}</div>
          <div>
            <h2 class="text-white mb-1 fw-bold fs-1">سلام، {{ currentUser.name }}</h2>
            <p class="text-info fs-3 mb-0">{{ currentUser.dept }} • {{ currentUser.position }}</p>
          </div>
        </div>
        <div class="text-start">
          <div class="shamsi-date" id="shamsi"></div>
          <div id="clock" class="text-white fs-3"></div>
        </div>
      </div>

      <ul class="nav nav-tabs mb-5 fs-5">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#eval">ارزیابی همکاران</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#myeval">نمودار عملکرد من</a></li>
        <li v-if="isAdmin" class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#admin">پنل مدیریت</a></li>
        <li class="nav-item"><a @click="logout" class="nav-link text-danger">خروج</a></li>
      </ul>

      <div class="tab-content">
        <!-- ارزیابی -->
        <div class="tab-pane active" id="eval">
          <h3 class="text-center text-info mb-5 fw-bold display-6">انتخاب همکار برای ارزیابی</h3>
          <select v-model="selectedColleague" class="form-select form-select-lg glass mb-5 text-center fs-4 p-3">
            <option value="">انتخاب همکار</option>
            <option v-for="p in personnel" :value="p.code">{{ p.name }} - {{ p.dept }}</option>
          </select>

          <div v-if="selectedColleague" class="row g-4">
            <div class="col-md-6" v-for="(q,i) in questions" :key="i">
              <div class="card-eval text-center">
                <h5 class="text-white mb-4">{{ q }}</h5>
                <input type="range" class="form-range range-slider" min="1" max="5" v-model.number="scores[i]" @input="updateSlider($event.target,i)">
                <div class="mt-4">
                  <span class="fs-1 fw-bold" :style="{color:getColor(scores[i])}">{{ scores[i] }}</span>
                  <p class="text-white-50 fs-5">{{ getText(scores[i]) }}</p>
                </div>
              </div>
            </div>
          </div>
          <button v-if="selectedColleague" @click="submitEval" class="btn btn-success btn-lg w-100 mt-5 fs-3">ارسال ارزیابی</button>
        </div>

        <!-- نمودار من -->
        <div class="tab-pane" id="myeval">
          <div class="text-center py-5">
            <h2 class="text-info mb-5 display-4 fw-bold">نمودار عملکرد ۳۶۰ درجه شما</h2>
            <canvas id="radarChart" height="650"></canvas>
            <div class="mt-5">
              <h1 class="display-1 fw-bold" :class="'grade-'+grade">{{ grade }}</h1>
              <p class="fs-2 text-info">میانگین: {{ avgScore.toFixed(2) }} از ۵</p>
            </div>
          </div>
        </div>

        <!-- پنل مدیریت -->
        <div v-if="isAdmin" class="tab-pane" id="admin">
          <div class="text-center mb-5">
            <h2 class="text-warning display-5">پنل مدیریت سامانه</h2>
            <button @click="exportExcel" class="btn btn-outline-light btn-lg mt-3">دانلود گزارش کامل (Excel)</button>
          </div>
          <div class="table-responsive">
            <table class="table table-dark table-hover text-center">
              <thead class="table-primary">
                <tr><th>کد</th><th>نام</th><th>واحد</th><th>تعداد ارزیابی</th><th>میانگین</th><th>گرید</th></tr>
              </thead>
              <tbody>
                <tr v-for="p in personnel">
                  <td>{{ p.code }}</td>
                  <td>{{ p.name }}</td>
                  <td>{{ p.dept }}</td>
                  <td><span class="badge bg-info fs-5">{{ p.evals?.length || 0 }}</span></td>
                  <td class="fs-5">{{ calcAvg(p).toFixed(2) }}</td>
                  <td><h3 :class="'grade-'+getGrade(calcAvg(p))">{{ getGrade(calcAvg(p)) }}</h3></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let radarChart = null;

Vue.createApp({
  data:()=>({
    loginCode:'',loggedIn:false,isAdmin:false,currentUser:{},personnel:[],selectedColleague:'',
    scores:Array(12).fill(3),
    questions:["کیفیت و دقت در انجام وظایف","سرعت و به‌موقع بودن کارها","همکاری و کار تیمی","مسئولیت‌پذیری و تعهد","نوآوری و خلاقیت","انضباط و رعایت قوانین","ارتباطات و تعامل با همکاران","حل مسئله و تصمیم‌گیری","یادگیری و توسعه فردی","رهبری و هدایت دیگران","مدیریت زمان و اولویت‌بندی","رضایت مشتری داخلی/خارجی"]
  }),
  computed:{
    avgScore(){return this.currentUser.evals?.length?this.currentUser.evals.reduce((s,e)=>s+e.scores.reduce((a,b)=>a+b,0),0)/(this.currentUser.evals.length*12):0},
    grade(){const a=this.avgScore;return a>=4.5?'A':a>=4?'B':a>=3.5?'C':a>=3?'D':'E'}
  },
  methods:{
    login(){
      if(this.loginCode==='admin'){this.isAdmin=true;this.currentUser={name:'مدیر سیستم',dept:'مدیریت'};this.loggedIn=true;return}
      const u=this.personnel.find(p=>p.code===this.loginCode);
      if(u){this.currentUser=u;this.loggedIn=true;this.$nextTick(()=>this.drawRadar())}else alert('کد اشتباه!')
    },
    logout(){this.loggedIn=false;this.loginCode='';this.currentUser={}},
    initData(){
      this.personnel=[{code:"1001",name:"سیاوش قوچانی",dept:"فنی",position:"کارشناس",evals:[]},{code:"1004",name:"محمدرضا شفیعی",dept:"فنی",position:"مدیر پروژه",evals:[]},{code:"1007",name:"حدیقه کیقبادی",dept:"مالی",position:"حسابدار",evals:[]}];
      this.save()
    },
    submitEval(){
      const t=this.personnel.find(p=>p.code===this.selectedColleague);
      t.evals.push({from:this.currentUser.code,scores:[...this.scores]});
      this.save();alert('ارزیابی ثبت شد! عالی بودی ');
      this.selectedColleague='';this.scores=Array(12).fill(3);
      this.$nextTick(()=>this.drawRadar())
    },
    getColor(s){return s<=2?'#ef4444':s<=3?'#f59e0b':s==4?'#eab308':'#10b981'},
    getText(s){return['ضعیف','نیاز به بهبود','متوسط','خوب','عالی'][s-1]},
    updateSlider(el,i){
      const p=((this.scores[i]-1)/4)*100;
      el.style.background=`linear-gradient(to right,#ef4444 0%,#f59e0b ${p/2}%,#10b981 ${p}%,#10b981 100%)`
    },
    calcAvg(p){return p.evals?.length?p.evals.reduce((s,e)=>s+e.scores.reduce((a,b)=>a+b,0),0)/(p.evals.length*12):0},
    getGrade(a){return a>=4.5?'A':a>=4?'B':a>=3.5?'C':a>=3?'D':'E'},
    drawRadar(){
      const ctx=document.getElementById('radarChart');
      if(!ctx)return;
      if(radarChart)radarChart.destroy();
      const data=this.currentUser.evals?.length?this.currentUser.evals.reduce((a,e)=>e.scores.map((s,i)=>(a[i]=(a[i]||0)+s)),Array(12).fill(0)).map((s,i)=>s/this.currentUser.evals.length):Array(12).fill(3);
      radarChart=new Chart(ctx,{type:'radar',data:{labels:this.questions,datasets:[{label:'عملکرد شما',data,backgroundColor:'rgba(14,165,233,0.25)',borderColor:'#0ea5e9',pointBackgroundColor:'#8b5cf6',borderWidth:5,pointRadius:8}]},options:{scales:{r:{min:0,max:5,ticks:{stepSize:1,color:'#e2e8f0',font:{size:18}},pointLabels:{color:'#e2e8f0',font:{size:16,weight:'bold'}}}},plugins:{legend:{labels:{color:'#e2e8f0',font:{size:20}}}}}})
    },
    exportExcel(){
      const data=this.personnel.map(p=>({کد:p.code,نام:p.name,واحد:p.dept,تعداد_ارزیابی:p.evals?.length||0,میانگین:this.calcAvg(p).toFixed(2),گرید:this.getGrade(this.calcAvg(p))}));
      const ws=XLSX.utils.json_to_sheet(data);
      const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"گزارش ارزیابی");
      XLSX.writeFile(wb,"Mahrad360_Report.xlsx")
    },
    save(){localStorage.setItem('mahrad360_ultimate',JSON.stringify(this.personnel))},
    startClock(){
      setInterval(()=>{
        const d=new Date();
        const j=jalaali.toJalaali(d.getFullYear(),d.getMonth()+1,d.getDate());
        const s=document.getElementById('shamsi');if(s)s.innerText=`${j.jy}/${j.jm.toString().padStart(2,'0')}/${j.jd.toString().padStart(2,'0')}`;
        const c=document.getElementById('clock');if(c)c.innerText=d.toLocaleTimeString('fa-IR')
      },1000)
    }
  },
  created(){
    const s=localStorage.getItem('mahrad360_ultimate');
    if(s)this.personnel=JSON.parse(s);else this.initData()
  },
  mounted(){this.startClock()}
}).mount('#app');
</script>
</body>
</html>
