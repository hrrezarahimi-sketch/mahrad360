<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ماهراد ۳۶۰ - ارزیابی عملکرد</title>

  <!-- کتابخانه‌ها -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.6/dist/jalaali.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    body {background:#0f172a;color:#e2e8f0;font-family:'Vazirmatn',sans-serif;min-height:100vh;}
    .glass {background:rgba(30,41,59,0.95);backdrop-filter:blur(20px);border-radius:28px;border:1px solid #0ea5e933;box-shadow:0 20px 60px #000000b3;}
    .card-eval {background:#1e293b;border-radius:24px;padding:24px;transition:.4s;}
    .card-eval:hover {transform:translateY(-10px);box-shadow:0 20px 40px #0ea5e940;}
    .range-slider {height:16px;border-radius:50px;background:#334155;}
    .range-slider::-webkit-slider-thumb {appearance:none;width:38px;height:38px;border-radius:50%;background:#10b981;box-shadow:0 0 30px #10b98180;}
    .avatar {width:110px;height:110px;border-radius:50%;background:linear-gradient(45deg,#0ea5e9,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:3.5rem;color:#fff;font-weight:bold;}
    .shamsi {font-size:2.8rem;font-weight:900;background:linear-gradient(45deg,#8b5cf6,#ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .grade-A {color:#10b981;text-shadow:0 0 40px #10b98160;}
    .grade-B {color:#3b82f6;}
    .grade-C {color:#fbbf24;}
    .grade-D {color:#f97316;}
    .grade-E {color:#ef4444;text-shadow:0 0 40px #ef444460;}
  </style>
</head>
<body class="p-4">

<div id="app">
  <!-- ورود -->
  <div v-if="!loggedIn" class="d-flex justify-content-center align-items-center min-vh-100">
    <div class="text-center">
      <img src="https://i.ibb.co/4g5v5sF/mahrad-logo-real.png" width="240" class="mb-4 rounded-4 shadow">
      <h1 class="text-white display-4 fw-bold mb-5">سامانه ارزیابی ۳۶۰ درجه</h1>
      <div class="glass p-5 col-md-5">
        <input v-model="loginCode" class="form-control form-control-lg text-center mb-4 fs-2" placeholder="کد پرسنلی" autofocus>
        <button @click="login" class="btn btn-primary btn-lg w-100">ورود</button>
        <small class="text-info mt-3 d-block">مدیر: admin</small>
      </div>
    </div>
  </div>

  <!-- داشبورد -->
  <div v-else class="container">
    <div class="glass p-5">
      <div class="d-flex justify-content-between align-items-center mb-5">
        <div class="d-flex align-items-center gap-4">
          <div class="avatar">{{ currentUser.name?.[0] }}</div>
          <div>
            <h2 class="text-white fw-bold fs-1 mb-1">سلام، {{ currentUser.name }}</h2>
            <p class="text-info fs-3">{{ currentUser.dept }} • {{ currentUser.position }}</p>
          </div>
        </div>
        <div>
          <div class="shamsi" ref="shamsi">۱۴۰۴/۰۹/۰۳</div>
          <div class="text-white fs-3" ref="clock">۰۰:۰۰:۰۰</div>
        </div>
      </div>

      <ul class="nav nav-tabs mb-5">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#eval">ارزیابی</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#chart">نمودار من</a></li>
        <li v-if="isAdmin" class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#admin">مدیریت</a></li>
        <li class="nav-item"><a @click="logout" class="nav-link text-danger">خروج</a></li>
      </ul>

      <div class="tab-content">
        <!-- ارزیابی -->
        <div class="tab-pane active" id="eval">
          <select v-model="targetCode" class="form-select form-select-lg glass mb-5 text-center">
            <option value="">انتخاب همکار برای ارزیابی</option>
            <option v-for="p in personnel" :value="p.code">{{ p.name }} - {{ p.dept }}</option>
          </select>

          <div v-if="targetCode" class="row g-4">
            <div class="col-md-6" v-for="(q,i) in questions" :key="i">
              <div class="card-eval text-center">
                <h5 class="text-white mb-4">{{ q }}</h5>
                <input type="range" class="form-range range-slider" min="1" max="5" v-model.number="scores[i]" @input="colorSlider($event.target,i)">
                <div class="mt-4">
                  <span class="fs-1 fw-bold" :style="{color:scoreColor(scores[i])}">{{ scores[i] }}</span>
                  <p class="text-white-50 fs-5">{{ scoreText(scores[i]) }}</p>
                </div>
              </div>
            </div>
          </div>
          <button v-if="targetCode" @click="submit" class="btn btn-success btn-lg w-100 mt-5">ارسال ارزیابی</button>
        </div>

        <!-- نمودار -->
        <div class="tab-pane" id="chart">
          <div class="text-center py-5">
            <h2 class="text-info display-5 mb-5">نمودار عملکرد ۳۶۰ درجه شما</h2>
            <canvas ref="radar" height="600"></canvas>
            <h1 class="display-1 mt-5" :class="'grade-'+myGrade">{{ myGrade }}</h1>
            <p class="fs-2 text-info">میانگین: {{ myAvg.toFixed(2) }} از ۵</p>
          </div>
        </div>

        <!-- مدیریت -->
        <div v-if="isAdmin" class="tab-pane" id="admin">
          <div class="text-center mb-4">
            <button @click="exportExcel" class="btn btn-outline-light btn-lg">دانلود گزارش اکسل</button>
          </div>
          <div class="table-responsive">
            <table class="table table-dark table-hover">
              <thead class="table-primary"><tr><th>کد</th><th>نام</th><th>واحد</th><th>تعداد ارزیابی</th><th>میانگین</th><th>گرید</th></tr></thead>
              <tbody>
                <tr v-for="p in personnel">
                  <td>{{p.code}}</td><td>{{p.name}}</td><td>{{p.dept}}</td>
                  <td>{{p.evals?.length||0}}</td>
                  <td>{{avg(p).toFixed(2)}}</td>
                  <td><strong :class="'grade-'+grade(avg(p))">{{grade(avg(p))}}</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let chartInstance = null;

const app = Vue.createApp({
  data() { return {
    loginCode: '', loggedIn: false, isAdmin: false, currentUser: {}, personnel: [], targetCode: '',
    scores: Array(12).fill(3),
    questions: ["کیفیت و دقت","سرعت کار","همکاری تیمی","مسئولیت‌پذیری","نوآوری","انضباط","ارتباطات","حل مسئله","یادگیری","رهبری","مدیریت زمان","رضایت مشتری"]
  }},
  computed: {
    myAvg() { return this.currentUser.evals?.length ? this.currentUser.evals.reduce((a,e)=>a+e.scores.reduce((x,y)=>x+y,0),0)/(this.currentUser.evals.length*12) : 0 },
    myGrade() { const a=this.myAvg; return a>=4.5?'A':a>=4?'B':a>=3.5?'C':a>=3?'D':'E' }
  },
  methods: {
    login() {
      if (this.loginCode==='admin') { this.isAdmin=true; this.currentUser={name:'مدیر سیستم',dept:'مدیریت'}; this.loggedIn=true; return }
      const user = this.personnel.find(x=>x.code===this.loginCode);
      if (user) { this.currentUser=user; this.loggedIn=true; this.$nextTick(()=>this.drawChart()) }
      else alert('کد اشتباه!')
    },
    logout() { this.loggedIn=false; this.loginCode='' },
    submit() {
      const target = this.personnel.find(x=>x.code===this.targetCode);
      target.evals = target.evals || [];
      target.evals.push({from:this.currentUser.code, scores:[...this.scores]});
      localStorage.setItem('mahrad360', JSON.stringify(this.personnel));
      alert('ارزیابی ثبت شد!');
      this.targetCode=''; this.scores=Array(12).fill(3);
      if (target.code===this.currentUser.code) this.$nextTick(()=>this.drawChart());
    },
    avg(p) { return p.evals?.length ? p.evals.reduce((a,e)=>a+e.scores.reduce((x,y)=>x+y,0),0)/(p.evals.length*12) : 0 },
    grade(a) { return a>=4.5?'A':a>=4?'B':a>=3.5?'C':a>=3?'D':'E' },
    scoreColor(s) { return s<=2?'#ef4444':s<=3?'#f59e0b':s==4?'#eab308':'#10b981' },
    scoreText(s) { return ['ضعیف','نیاز به بهبود','متوسط','خوب','عالی'][s-1] },
    colorSlider(el,i) {
      const p = (this.scores[i]-1)/4*100;
      el.style.background = `linear-gradient(to right, #ef4444 0%, #f59e0b ${p/2}%, #10b981 ${p}%, #10b981 100%)`;
    },
    drawChart() {
      if (chartInstance) chartInstance.destroy();
      const data = this.currentUser.evals?.length ? 
        this.currentUser.evals.reduce((a,e)=>e.scores.map((s,i)=>(a[i]=(a[i]||0)+s,a[i]),a),Array(12).fill(0)).map((s,i)=>s/this.currentUser.evals.length) :
        Array(12).fill(3);
      chartInstance = new Chart(this.$refs.radar, {
        type: 'radar',
        data: { labels: this.questions, datasets: [{ label: 'عملکرد شما', data, backgroundColor: 'rgba(14,165,233,0.3)', borderColor: '#0ea5e9', pointBackgroundColor: '#8b5cf6', borderWidth: 4, pointRadius: 7 }] },
        options: { scales: { r: { min:0, max:5, ticks:{stepSize:1}, pointLabels:{font:{size:16,weight:'bold'},color:'#e2e8f0'} } } }
      });
    },
    exportExcel() {
      const data = this.personnel.map(p=>({کد:p.code,نام:p.name,واحد:p.dept,تعداد:p.evals?.length||0,میانگین:this.avg(p).toFixed(2),گرید:this.grade(this.avg(p))}));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"گزارش");
      XLSX.writeFile(wb,"Mahrad360.xlsx");
    },
    startClock() {
      setInterval(()=>{
        const d = new Date();
        const j = jalaali.toJalaali(d.getFullYear(),d.getMonth()+1,d.getDate());
        if (this.$refs.shamsi) this.$refs.shamsi.innerText = `${j.jy}/${j.jm.toString().padStart(2,'0')}/${j.jd.toString().padStart(2,'0')}`;
        if (this.$refs.clock) this.$refs.clock.innerText = d.toLocaleTimeString('fa-IR');
      },1000);
    }
  },
  created() {
    const saved = localStorage.getItem('mahrad360');
    if (saved) this.personnel = JSON.parse(saved);
    else { this.personnel = [{code:"1001",name:"سیاوش قوچانی",dept:"فنی",position:"کارشناس",evals:[]},{code:"1004",name:"محمدرضا شفیعی",dept:"فنی",position:"مدیر پروژه",evals:[]},{code:"1007",name:"حدیقه کیقبادی",dept:"مالی",position:"حسابدار",evals:[]}]; localStorage.setItem('mahrad360',JSON.stringify(this.personnel)) }
  },
  mounted() { this.startClock() }
});

app.mount('#app');
</script>
</body>
</html>
