<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ماهراد ۳۶۰ - سامانه ارزیابی عملکرد</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.6/dist/jalaali.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    body{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-family:'Vazirmatn',sans-serif;min-height:100vh}
    .glass{background:rgba(255,255,255,0.12);backdrop-filter:blur(20px);border-radius:20px;border:1px solid rgba(255,255,255,0.2);box-shadow:0 15px 35px rgba(0,0,0,0.3)}
    .card{background:rgba(255,255,255,0.1);backdrop-filter:blur(15px);border-radius:18px;border:none;transition:.4s}
    .card:hover{transform:translateY(-10px)}
    .grade-circle{width:150px;height:150px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:5rem;font-weight:900;box-shadow:0 0 50px}
    .A{background:#10b981;box-shadow:0 0 50px #10b98190}
    .B{background:#3b82f6;box-shadow:0 0 50px #3b82f690}
    .C{background:#fbbf24;box-shadow:0 0 50px #fbbf2490}
    .D{background:#f97316;box-shadow:0 0 50px #f9731690}
    .E{background:#ef4444;box-shadow:0 0 50px #ef444490}
    .shamsi{font-size:3rem;font-weight:900;background:linear-gradient(45deg,#fff,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .dept-header{background:rgba(255,255,255,0.15);border-radius:12px;padding:15px;margin-bottom:15px;cursor:pointer}
    .progress-ring{position:relative;width:170px;height:170px}
    .progress-ring svg{transform:rotate(-90deg)}
    .progress-ring circle{fill:none;stroke:#334155;stroke-width:15}
    .progress-ring .bar{stroke:#10b981;stroke-linecap:round;stroke-width:15;transition:.8s}
    .progress-ring .text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2.5rem;font-weight:900}
  </style>
</head>
<body class="p-4">

<div id="app">
  <!-- صفحه ورود -->
  <div v-if="!isLoggedIn" class="d-flex align-items-center justify-content-center min-vh-100">
    <div class="glass p-5 text-center" style="max-width:450px">
      <h1 class="display-3 fw-bold mb-4">ماهراد ۳۶۰</h1>
      <input v-model="loginCode" @keyup.enter="doLogin" class="form-control form-control-lg text-center mb-4 fs-2" placeholder="کد پرسنلی" autofocus>
      <button @click="doLogin" class="btn btn-light btn-lg w-100 fs-3">ورود</button>
      <small class="d-block mt-4 text-warning">مدیر → کد: admin</small>
    </div>
  </div>

  <!-- داشبورد -->
  <div v-else class="glass p-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="shamsi">{{shamsiDate}}</h1>
        <h2>سامانه ارزیابی عملکرد ۳۶۰ درجه</h2>
      </div>
      <button @click="doLogout" class="btn btn-outline-light btn-lg">خروج</button>
    </div>

    <!-- فقط مدیر -->
    <div v-if="isAdmin" class="row g-4 mb-5 text-center">
      <div class="col-12">
        <div class="card p-4">
          <h3>آپلود لیست پرسنل (اکسل)</h3>
          <input type="file" @change="importExcel" accept=".xlsx" class="form-control form-control-lg mb-3">
          <small class="text-warning">ستون‌ها: کد، نام، واحد، سمت</small>
        </div>
      </div>
      <div class="col-lg-3 col-md-6" v-for="dept in departments">
        <div class="card p-4">
          <h4>{{dept.name}}</h4>
          <h2>{{dept.count}} نفر</h2>
          <div class="progress mt-3" style="height:30px">
            <div class="progress-bar bg-success" :style="{width: (dept.avg * 20) + '%'}">{{dept.avg.toFixed(2)}}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- فقط پرسنل -->
    <div v-if="!isAdmin" class="row g-4 text-center mb-5">
      <div class="col-md-3"><div class="card p-4"><h5>تکمیل ارزیابی</h5><div class="progress-ring mx-auto"><svg width="170" height="170"><circle cx="85" cy="85" r="77"/><circle cx="85" cy="85" r="77" class="bar" :stroke-dasharray="502" :stroke-dashoffset="offset"/></svg><div class="text">{{percent}}%</div></div></div></div>
      <div class="col-md-3"><div class="card p-4"><h5>پاداش سه‌ماهه</h5><h1 class="text-warning">{{bonus.toLocaleString('fa-IR')}} تومان</h1></div></div>
      <div class="col-md-3"><div class="card p-4"><h5>گرید عملکرد</h5><div class="grade-circle mx-auto" :class="grade">{{grade}}</div></div></div>
      <div class="col-md-3"><div class="card p-4"><h5>امتیاز کل</h5><h1>{{avg.toFixed(2)}} از ۵</h1></div></div>
    </div>

    <div class="row">
      <div class="col-lg-8">
        <div class="card p-4">
          <h3 class="text-center mb-4">{{isAdmin ? 'میانگین عملکرد دپارتمان‌ها' : 'نمودار عملکرد من'}}</h3>
          <canvas ref="radarChart" height="420"></canvas>
        </div>
      </div>
      <div class="col-lg-4">
        <div v-if="isAdmin" class="card p-4">
          <h4>دپارتمان‌ها</h4>
          <div v-for="d in departments" class="dept-header mb-2" @click="d.show=!d.show">
            <strong>{{d.name}} ({{d.count}} نفر)</strong>
            <div v-if="d.show" class="mt-3 small text-start">
              <div v-for="p in d.people">{{p.name}} - {{p.position||'—'}}</div>
            </div>
          </div>
        </div>
        <div v-else class="card p-4">
          <h4>اطلاعات من</h4>
          <p><strong>نام:</strong> {{currentUser.name}}</p>
          <p><strong>واحد:</strong> {{currentUser.dept || '—'}}</p>
          <p><strong>سمت:</strong> {{currentUser.position || '—'}}</p>
        </div>
      </div>
    </div>

    <!-- ارزیابی -->
    <ul class="nav nav-tabs mt-5">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#eval">ارزیابی همکاران</a></li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane active card p-4" id="eval">
        <select v-model="selectedTarget" class="form-select form-select-lg mb-4">
          <option :value="null">انتخاب همکار</option>
          <option v-for="p in people" :value="p" v-if="p.code !== currentUser.code">{{p.name}} - {{p.dept}}</option>
        </select>
        <div v-if="selectedTarget" class="row g-3">
          <div class="col-md-6" v-for="(q,i) in questions" :key="i">
            <label class="form-label fw-bold">{{q}}</label>
            <input type="range" class="form-range" min="1" max="5" v-model.number="tempScores[i]" @input="e=>e.target.style.background=`linear-gradient(to right,#ef4444 ${(tempScores[i]-1)*25}%,#10b981 ${(tempScores[i]-1)*25}%)`">
            <div class="d-flex justify-content-between mt-1"><small>ضعیف</small><strong class="fs-4">{{tempScores[i]}}</strong><small>عالی</small></div>
          </div>
        </div>
        <button v-if="selectedTarget" @click="submitEval" class="btn btn-success btn-lg w-100 mt-4">ارسال ارزیابی</button>
      </div>
    </div>
  </div>
</div>

<script>
const { createApp, ref, computed, onMounted, nextTick } = Vue;
let chart = null;

createApp({
  setup() {
    const isLoggedIn = ref(false);
    const isAdmin = ref(false);
    const loginCode = ref('');
    const currentUser = ref({ name: '', dept: '', position: '', code: '' });
    const people = ref([]);
    const selectedTarget = ref(null);
    const tempScores = ref(Array(21).fill(3));
    const radarChart = ref(null);
    const shamsiDate = ref('');
    const questions = ["دقت و کیفیت کار","سرعت انجام کار","همکاری تیمی","مسئولیت پذیری","نوآوری و خلاقیت","انضباط کاری","ارتباطات موثر","حل مسئله","یادگیری و توسعه","رهبری","مدیریت زمان","رضایت مشتری","تعهد سازمانی","مدیریت استرس","انعطاف پذیری","کار تحت فشار","ارائه گزارش","رعایت ایمنی","بهبود مستمر","مشارکت در جلسات","حفظ محرمانگی"];

    const load = () => {
      const d = localStorage.getItem('mahrad360_final_perfect');
      if (d) people.value = JSON.parse(d);
    };
    const save = () => localStorage.setItem('mahrad360_final_perfect', JSON.stringify(people.value));

    const doLogin = async () => {
      if (loginCode.value === 'admin') {
        isAdmin.value = true;
        currentUser.value = { name: 'مدیر سیستم', code: 'admin' };
      } else {
        const p = people.value.find(x => x.code === loginCode.value);
        if (!p) { alert('کد اشتباه'); return; }
        isAdmin.value = false;
        currentUser.value = p;
      }
      isLoggedIn.value = true;
      await nextTick();
      drawChart();
    };

    const doLogout = () => {
      isLoggedIn.value = false;
      isAdmin.value = false;
      loginCode.value = '';
      currentUser.value = { name: '', dept: '', position: '', code: '' };
    };

    const departments = computed(() => {
      const map = {};
      people.value.forEach(p => {
        const dept = p.dept || 'نامشخص';
        if (!map[dept]) map[dept] = { name: dept, count: 0, people: [], avg: 0, show: false };
        map[dept].count++;
        map[dept].people.push(p);
      });
      Object.values(map).forEach(d => {
        d.avg = d.people.reduce((a, p) => a + calcAvg(p), 0) / d.count || 0;
      });
      return Object.values(map);
    });

    const calcAvg = p => p.evals?.length ? p.evals.reduce((a,e) => a + e.scores.reduce((x,y)=>x+y,0),0)/(p.evals.length*21) : 0;

    const avg = computed(() => isAdmin.value ? 0 : calcAvg(currentUser.value));
    const grade = computed(() => {
      const a = avg.value;
      return a >= 4.5 ? 'A' : a >= 4 ? 'B' : a >= 3.5 ? 'C' : a >= 3 ? 'D' : 'E';
    });
    const percent = computed(() => Math.round((avg.value / 5) * 100));
    const bonus = computed(() => Math.round(avg.value * 1800000 * (grade.value === 'D' ? 0.8 : grade.value === 'E' ? 0.5 : 1)));
    const offset = computed(() => 502 - (502 * percent.value / 100));

    const drawChart = () => {
      if (!radarChart.value) return;
      if (chart) chart.destroy();

      let data = [], labels = [];
      if (isAdmin.value) {
        departments.value.forEach(d => { data.push(d.avg); labels.push(d.name); });
      } else {
        data = currentUser.value.evals?.length
          ? currentUser.value.evals.reduce((a,e) => e.scores.map((s,i) => (a[i]||0)+s), Array(21).fill(0)).map(v => v / currentUser.value.evals.length)
          : Array(21).fill(3);
        labels = questions;
      }

      chart = new Chart(radarChart.value, {
        type: 'radar',
        data: { labels, datasets: [
          { label: isAdmin.value ? 'میانگین' : 'عملکرد من', data, backgroundColor: 'rgba(99,102,241,0.3)', borderColor: '#6366f1', borderWidth: 4 },
          { label: 'هدف', data: Array(labels.length).fill(5), borderColor: '#ef4444', borderWidth: 3, borderDash: [10,5] }
        ]},
        options: { scales: { r: { min: 0, max: 5, ticks: { stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.2)' }, pointLabels: { color: '#fff' } } }, plugins: { legend: { labels: { color: '#fff' } } } }
      });
    };

    const submitEval = () => {
      selectedTarget.value.evals = selectedTarget.value.evals || [];
      selectedTarget.value.evals.push({ from: currentUser.value.code, scores: [...tempScores.value] });
      save();
      alert('ارزیابی ثبت شد');
      selectedTarget.value = null;
      tempScores.value = Array(21).fill(3);
      drawChart();
    };

    const importExcel = e => {
      const f = e.target.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = a => {
        const wb = XLSX.read(a.target.result);
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        people.value = rows.map(x => ({ code: String(x.کد||''), name: x.نام||'', dept: x.واحد||'نامشخص', position: x.سمت||'', evals: [] }));
        save();
        alert(`${people.value.length} نفر وارد شد!`);
        drawChart();
      };
      r.readAsArrayBuffer(f);
    };

    onMounted(() => {
      load();
      setInterval(() => {
        const d = new Date();
        const j = jalaali.toJalaali(d.getFullYear(), d.getMonth()+1, d.getDate());
        shamsiDate.value = `${j.jy}/${j.jm.toString().padStart(2,'0')}/${j.jd.toString().padStart(2,'0')}`;
      }, 1000);
    });

    return { isLoggedIn, isAdmin, loginCode, currentUser, people, selectedTarget, tempScores, radarChart, shamsiDate, questions, percent, bonus, grade, avg, departments, offset, doLogin, doLogout, submitEval, drawChart, importExcel };
  }
}).mount('#app');
</script>
</body>
</html>
