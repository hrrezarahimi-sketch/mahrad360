<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ماهراد ۳۶۰ - ارزیابی عملکرد</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚡</text></svg>">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    body{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-family:'Vazirmatn',sans-serif;min-height:100vh;margin:0}
    .glass{background:rgba(255,255,255,0.12);backdrop-filter:blur(20px);border-radius:20px;border:1px solid rgba(255,255,255,0.2);box-shadow:0 15px 35px rgba(0,0,0,0.3)}
    .card{background:rgba(255,255,255,0.1);backdrop-filter:blur(15px);border-radius:18px;border:none;transition:.4s}
    .card:hover{transform:translateY(-8px)}
    .grade-circle{width:150px;height:150px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:5rem;font-weight:900;box-shadow:0 0 50px}
    .A{background:#10b981;box-shadow:0 0 50px #10b98190}
    .B{background:#3b82f6;box-shadow:0 0 50px #3b82f690}
    .C{background:#fbbf24;box-shadow:0 0 50px #fbbf2490}
    .D{background:#f97316;box-shadow:0 0 50px #f9731690}
    .E{background:#ef4444;box-shadow:0 0 50px #ef444490}
    .shamsi{font-size:3.2rem;font-weight:900;background:linear-gradient(45deg,#fff,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .progress-ring{position:relative;width:170px;height:170px}
    .progress-ring svg{transform:rotate(-90deg)}
    .progress-ring circle{fill:none;stroke:#334155;stroke-width:15}
    .progress-ring .bar{stroke:#10b981;stroke-linecap:round;stroke-width:15;transition:.8s}
    .progress-ring .text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2.8rem;font-weight:900}
  </style>
</head>
<body class="p-4">

<div id="app" v-cloak>
  <div v-if="!loggedIn" class="d-flex align-items-center justify-content-center min-vh-100">
    <div class="glass p-5 text-center" style="max-width:460px;width:100%">
      <h1 class="display-2 fw-bold mb-5 text-warning">ماهراد ۳۶۰</h1>
      <input v-model="loginCode" @keyup.enter="doLogin" class="form-control form-control-lg text-center mb-4 fs-1" placeholder="کد پرسنلی" autofocus>
      <button @click="doLogin" class="btn btn-light btn-lg w-100 fs-3 fw-bold">ورود</button>
      <small class="d-block mt-4 text-info">مدیر → کد: <code>admin</code></small>
    </div>
  </div>

  <div v-else class="glass p-5">
    <div class="d-flex justify-content-between align-items-center mb-5">
      <div>
        <h1 class="shamsi mb-2">{{shamsiDate}}</h1>
        <h2 class="fw-bold fs-3">سامانه ارزیابی عملکرد ۳۶۰ درجه</h2>
      </div>
      <button @click="doLogout" class="btn btn-outline-light btn-lg px-5">خروج</button>
    </div>

    <!-- مدیر -->
    <div v-if="currentUser.code === 'admin'" class="row g-4 mb-5 text-center">
      <div class="col-12">
        <div class="card p-4">
          <h3>آپلود لیست پرسنل (اکسل)</h3>
          <input type="file" @change="importExcel" accept=".xlsx,.xls" class="form-control form-control-lg mb-3">
          <small class="text-warning">ستون‌ها: کد، نام، واحد، سمت</small>
        </div>
      </div>
      <div class="col-lg-4 col-md-6" v-for="d in departments">
        <div class="card p-4">
          <h4>{{d.name}}</h4>
          <h2>{{d.count}} نفر</h2>
          <div class="progress mt-3" style="height:30px">
            <div class="progress-bar bg-success" :style="{width: (d.avg * 20) + '%'}">{{d.avg.toFixed(2)}}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- پرسنل -->
    <div v-else class="row g-4 text-center mb-5">
      <div class="col-md-3 col-6"><div class="card p-4"><h5>تکمیل ارزیابی</h5><div class="progress-ring mx-auto"><svg width="170" height="170"><circle cx="85" cy="85" r="77"/><circle cx="85" cy="85" r="77" class="bar" stroke-dasharray="502" :stroke-dashoffset="offset"/></svg><div class="text">{{percent}}%</div></div></div></div>
      <div class="col-md-3 col-6"><div class="card p-4"><h5>پاداش</h5><h1 class="text-warning">{{bonus.toLocaleString('fa-IR')}} تومان</h1></div></div>
      <div class="col-md-3 col-6"><div class="card p-4"><h5>گرید</h5><div class="grade-circle mx-auto" :class="grade">{{grade}}</div></div></div>
      <div class="col-md-3 col-6"><div class="card p
